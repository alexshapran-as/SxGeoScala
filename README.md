# SxGeoScala
API for determining geolocation by ip address

[![Build Status](https://travis-ci.org/alexshapran-as/SxGeoScala.svg?branch=master)](https://travis-ci.org/alexshapran-as/SxGeoScala) 

## Easy start
fatJar архив `API-ip-assembly-0.1.jar` со всеми необходимыми классами и зависимостями может быть развернут с помощью следующей команды:

`java -jar target/scala-2.12/API-ip-assembly-0.1.jar '#scala'`

## Rest API
Доступные параметры: 
* ip
* show (city, region, country)

Каждый	запрос	к	API	должен	содержать	HTTP	header	Signature.	
Для	вычисления	подписи	Signature	используется	алгоритм	HMAC-SHA256.	
Подписи	подлежит тело	запроса без переноса строк и пробелов, например: `{"ip":"1.0.0.0","show":"city"}`.

Пример запроса:

 `curl -X POST \                                   `  
 ` http://localhost:8080/SxGeoScala/location/find \`  
 `-H 'Content-Type: application/json' \            `  
 `-H 'Host: localhost:8080' \                      `  
 `-H 'cache-control: no-cache' \                   `  
 `-H 'signature: ***' \                            `  
 `-d '{ "ip": "28.50.35.214", "show": "" }'        `

Пример ответа:
```json
{
"success": "true",
"result": {
  "Region" : {
      "name_en" : "California",
      "name_ru" : "Калифорния",
      "iso" : "US-CA",
      "id" : "5332921",
      "country_seek" : "5967"
      },
    "City" : {
      "name_en" : "Norwalk",
      "name_ru" : "Норуолк",
      "region_seek" : "9881",
      "id" : "5377995",
      "lon" : "-118.08172",
      "country_id" : "225",
      "lat" : "33.90224"
    },
    "Country" : {
      "name_en" : "United States",
      "name_ru" : "США",
      "iso" : "US",
      "id" : "225",
      "lon" : "556.86",
      "lat" : "39.76"
    }
  }  
}
```

## Формат хранения данных в Sypex Geo
__Sypex Geo__ – продукт для определения местоположения посетителя по IP-адресу, от создателей Sypex Dumper. Данный продукт распространяется по лицензии BSD, т. е. является абсолютно бесплатным, и представляет собой файл базы данных расширения `.dat`, в котором вся информация хранится в hex формате.
### Структура БД
Файл базы данных Sypex Geo версии 2.2 (сокращенно SxGeo v2.2) состоит из:

1) Заголовока 
2) Индекса первых октетов (байт)
3) Основного индекса
4) Диапазонов IP-адресов
5) Справочника регионов (опционально)
6) Справочника стран (опционально)
7) Справочника городов (опционально)

#### Заголовок
Заголовок содержит 40 байт информации о содержимом БД. Структура заголовка, а также значения для примера представлены в следующей таблице.

| №  | Смещение | Размер | Значение                | Описание                                                    |
|----|:--------:|-------:|------------------------:|------------------------------------------------------------:|
| 1  | 0        | 3      | SxG                     | Идентификатор файла, "SxG"                                  | 
| 2  | 3        | 1      | 22                      | Версия файла (22 => 2.2)                                    |
| 3  | 4        | 4      | 2019-04-30T19:45:33     | Время создания (Unix timestamp, преобразовано)              |
| 4  | 8        | 1      | 3                       | Парсер (0 - Universal, 1 - SxGeo Country, 2 - SxGeo City, 3 - SxGeo City EN, 11 - GeoIP Country, 12- GeoIP City, 21 - ipgeobase)                                                     |
| 5  | 9        | 1      | 0                       | Кодировка (0 - UTF-8, 1 - latin1, 2 - cp1251)               | 
| 6  | 10       | 1      | 224                     | Элементов в индексе первых байт (до 255)                    |
| 7  | 11       | 2      | 1775                    | Элементов в основном индексе (до 65 тыс.)                   | 
| 8  | 13       | 2      | 2785                    | Блоков в одном элементе индекса (до 65 тыс.)                |
| 9  | 15       | 4      | 4946000                 | Количество диапазонов (до 4 млрд.)                          | 
| 10 | 19       | 1      | 3                       | Размер ID-блока в байтах (1 для стран, 3 для городов)       |
| 11 | 20       | 2      | 175                     | Максимальный размер записи региона (до 64 КБ)               | 
| 12 | 22       | 2      | 127                     | Максимальный размер записи города (до 64 КБ)                |
| 13 | 24       | 4      | 109102                  | Размер справочника регионов                                 | 
| 14 | 28       | 4      | 2625678                 | Размер справочника городов                                  |
| 15 | 32       | 2      | 147                     | Максимальный размер записи страны (до 64 КБ)                | 
| 16 | 34       | 4      | 9387                    | Размер справочника стран                                    |
| 17 | 38       | 2      | 157                     | Размер описания формата упаковки страны/региона/города      | 
| 18 | 40       | N      |                         | Описания формата упаковки страны/региона/города             |

__Примечание:__ для хранения чисел во всех разделах, кроме справочников используется порядок байт - от старшего к младшему (__big-endian__). В справочниках числа хранятся в __little-endian__. Все числа являются беззнаковыми целыми. Однако значения широты и долготы могут оказаться отрицательными, для этого значения в hex формате для широты и долготы хранятся в следующем виде:

Первый байт числа определяет знак числа. Если первый байт числа равен `0xff`, то число отрицательное и, чтобы получить необходимое число, нужно инвертировать оставшиеся байты, а затем перевести hex в decimal и указать, что это отрицательное число. Если первый байт числа не равен `0xff`, то необходимо просто перевести hex в decimal.


#### Индекс первых байт (октетов)
Индекс первых байт состоит из 4-байтных чисел, содержащих смещение в базе для каждого первого байта. 4 байта вместо 3-х выбрано в силу значительно большей скорости преобразования 4-байтных чисел и незначительном увеличении занимаемого места. Содержит 224 значения от 0 до 223, так как адреса с 224 и выше зарезервированы (но предусмотрена возможность увеличения этого значения до 255).

#### Основной индекс
Основной индекс состоит из 4-байтных подряд идущих первых IP-адресов. Каждому первому IP-адресу соответствуют определенные диапазоны из раздела диапазонов IP-адресов. Размер блока с диапазонами для каждого первого IP-адреса указан в заголовке.

#### Диапазоны
Диапазоны хранятся в виде 3 байт (IP начала диапазона без первого байта) + от 1 до 4 байт, хранящих ID объекта либо смещение записи в справочнике. В базе данных SxGeo City (EN) ID блок имеет размер 3 байта и представляет собой смещение в справочнике, состоящем из справочников стран и городов. Конечные диапазоны не хранятся. Во время создания базы данных при обнаружении "дырок" между двумя диапазонами между ними автоматически вставляется пустой диапазон со значением ID равным 0. Таким образом база данных покрывает абсолютно все IP, и концом текущего диапазона всегда является начало следующего диапазона.
Размер ID указывается в Заголовке (Размер ID-блока).

#### Справочник регионов
Регионы хранятся в универсальном формате упаковки данных. По полученному смещению, которое вычисляется по полю region_seek (информация о полях указывается в формате упаковки данных) после парсинга соответствующего города, считывается строка максимальной для записи  региона длины (указано в Заголовке), после этого строка распаковывается с использованием формата, указанного в заголовке.
Справочник регионов является опциональным.

#### Справочник стран
Страны хранятся в универсальном формате упаковки данных. По полученному смещению, которое вычисляется по полю country_seek (информация о полях указывается в формате упаковки данных) после парсинга соответствующего региона, считывается строка максимальной для страны длины, после этого строка распаковывается с использованием формата, указанного в заголовке. Справочник стран совмещается со справочником городов (так как могут быть IP у которых не определен город).
Справочник стран является опциональным.

#### Справочник городов
Города хранятся в универсальном формате упаковки данных. По полученному смещению, которое вычисляется как разница ID соответствующего диапазона и размера справочника стран (если ID оказывается меньше размера справочника стран, то вместо разницы берется просто ID диапазона), считывается строка максимальной для города длины, после этого строка распаковывается с использованием формата, указанного в заголовке.
Справочник городов является опциональным.

Подробнее об универсальной упаковке данных и о другой информации можно узнать на официальном сайте Sypex Geo: 
* Главная страница https://sypexgeo.net/ru/
* Спецификация https://sypexgeo.net/ru/docs/sxgeo22/

